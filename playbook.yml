---
- name: Observability Stack for EKS - Scenario 1 (Auto Scaling Pod + Node)
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    kube_context: "eks-observability"
    ns_monitoring: "monitoring"

  tasks:
    # -------------------- 1️⃣ Namespace & Helm Repositories --------------------
    - name: Ensure monitoring namespace exists
      kubernetes.core.k8s:
        api_version: v1
        kind: Namespace
        name: "{{ ns_monitoring }}"
        state: present

    - name: Add Helm repositories
      kubernetes.core.helm_repository:
        name: "{{ item.name }}"
        repo_url: "{{ item.url }}"
      loop:
        - { name: prometheus-community, url: "https://prometheus-community.github.io/helm-charts" }
        - { name: grafana,               url: "https://grafana.github.io/helm-charts" }
        - { name: metrics-server,        url: "https://kubernetes-sigs.github.io/metrics-server/" }
      ignore_errors: true

    # -------------------- 2️⃣ Metrics Server (official chart) --------------------
    - name: Install official metrics-server
      kubernetes.core.helm:
        name: metrics-server
        chart_ref: metrics-server/metrics-server
        release_namespace: kube-system
        wait: true
        timeout: 600s
        values:
          args:
            - --kubelet-insecure-tls
            - --kubelet-preferred-address-types=InternalIP
            - --metric-resolution=15s
          resources:
            requests:
              cpu: 100m
              memory: 100Mi
            limits:
              cpu: 200m
              memory: 200Mi

    # -------------------- 3️⃣ Prometheus + Grafana --------------------
    - name: Install kube-prometheus-stack
      kubernetes.core.helm:
        name: kps
        chart_ref: prometheus-community/kube-prometheus-stack
        release_namespace: "{{ ns_monitoring }}"
        values: "{{ lookup('file', 'files/values-kps.yaml') | from_yaml }}"
        wait: false
        timeout: 0

    # -------------------- 4️⃣ Loki + Promtail + Tempo --------------------
    - name: Install Loki
      kubernetes.core.helm:
        name: loki
        chart_ref: grafana/loki
        release_namespace: "{{ ns_monitoring }}"
        values: "{{ lookup('file', 'files/values-loki.yaml') | from_yaml }}"
        wait: false
        timeout: 0

    - name: Install Promtail
      kubernetes.core.helm:
        name: promtail
        chart_ref: grafana/promtail
        release_namespace: "{{ ns_monitoring }}"
        values: "{{ lookup('file', 'files/values-promtail.yaml') | from_yaml }}"
        wait: false
        timeout: 0

    - name: Install Tempo
      kubernetes.core.helm:
        name: tempo
        chart_ref: grafana/tempo
        release_namespace: "{{ ns_monitoring }}"
        values: "{{ lookup('file', 'files/values-tempo.yaml') | from_yaml }}"
        wait: false
        timeout: 0

    # -------------------- 5️⃣ Icinga2 (optional, no wait) --------------------
    - name: Install Icinga2 monitoring
      kubernetes.core.helm:
        name: icinga2
        chart_ref: icinga/icinga2
        release_namespace: "{{ ns_monitoring }}"
        create_namespace: false
        wait: false
        timeout: 0
        values:
          persistence:
            enabled: false
          service:
            type: ClusterIP
          resources:
            requests:
              cpu: 100m
              memory: 256Mi
            limits:
              cpu: 500m
              memory: 512Mi
      ignore_errors: true

    # -------------------- 6️⃣ Grafana provisioning --------------------
    - name: Create Grafana provisioning ConfigMap
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-provisioning
            namespace: "{{ ns_monitoring }}"
            labels:
              grafana_datasource: "1"
              grafana_dashboard: "1"
          data:
            datasources.yaml: "{{ lookup('file', 'files/grafana/provisioning/datasources.yaml') }}"
            dashboards.yaml: "{{ lookup('file', 'files/grafana/provisioning/dashboards.yaml') }}"

    - name: Load Scenario1 dashboard
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: grafana-dashboard-scenario1
            namespace: "{{ ns_monitoring }}"
            labels:
              grafana_dashboard: "1"
          data:
            scenario1-overview.json: "{{ lookup('file', 'files/grafana/dashboards/scenario1-overview.json') }}"

    # -------------------- 7️⃣ Cluster Autoscaler metrics --------------------
    - name: Expose Cluster Autoscaler metrics
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', 'manifests/service-cluster-autoscaler.yaml') | from_yaml }}"

    - name: Create ServiceMonitor for Cluster Autoscaler
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', 'manifests/servicemonitor-cluster-autoscaler.yaml') | from_yaml }}"
